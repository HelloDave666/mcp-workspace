#!/usr/bin/env node

/**
 * LinkedIn Strategic Network Analyzer - TOKEN DIRECT VERSION
 * 
 * Version avec nouveau token LinkedIn int√©gr√© - SYNTAX FIXED
 * Focus: European funding ecosystem (Horizon Europe, Creative Europe, etc.)
 * Capabilities: Profile-based analysis, funding opportunities, strategic connections
 */

import { Server } from "@modelcontextprotocol/sdk/server/index.js";
import { StdioServerTransport } from "@modelcontextprotocol/sdk/server/stdio.js";
import {
  CallToolRequestSchema,
  ListToolsRequestSchema,
} from "@modelcontextprotocol/sdk/types.js";
import axios from 'axios';
import * as fs from 'fs-extra';
import * as path from 'path';

const server = new Server(
  {
    name: "linkedin-strategic",
    version: "2.1.0", // Version token direct
  },
  {
    capabilities: {
      tools: {},
    },
  }
);

// Configuration LinkedIn API avec NOUVEAU TOKEN FRESH
const LINKEDIN_CONFIG = {
  clientId: '78mjs116ddpk1k',
  clientSecret: 'WPL_AP1.USotCJnmRBxiKaB6.Wxr5pA==',
  redirectUri: 'https://www.linkedin.com/developers/tools/oauth/redirect',
  accessToken: 'AQWPvqiwcGDmzjQuhX5eQLgQMrUj2nng_izkE6TNSpQBrEGdRecbBSwvOB9LZVO_0l2o8Zbti0h-o2q7k52RtW8hIUHwgD1gRaBVmXaXtaXOJJG5PhuMzG2YWU0TfEMY-0Sb8xS_ut9Iv11dGcDZDbDwkbwO2ys1938plqJkTrj2M7Vd9T93GEGRellf6hjT2oDHj6IKZl_lmOwUYRCmfu3L3lVw6CJmv4a9NZKX_tOo-MKJT4sR9eHODe3sXd3pA7r4h2wr8tLLBsi4QJswtK5AH_nUdWTc5S0AnGCxzJcIfrhxFzVMAPMyKiayhU2XwWWuji6f1eRXA1nZo93cM4JXIxck1g',
  tokenFile: path.join(process.cwd(), 'linkedin-token.json'),
  tokenExpires: Date.now() + (60 * 24 * 60 * 60 * 1000) // Expires dans 60 jours (nouveau token frais)
};

// Base de donn√©es des programmes europ√©ens (enrichie)
const EUROPEAN_FUNDING_PROGRAMS = {
  'horizon-europe': {
    name: 'Horizon Europe',
    focus: ['digital', 'technology', 'research', 'innovation'],
    budget: '95.5B EUR',
    keywords: ['H2020', 'ERC', 'Marie Curie', 'EIC', 'Digital Europe', 'CRAFT'],
    clusters: ['Digital & Technology', 'Culture & Creativity', 'Industrial Technologies']
  },
  'creative-europe': {
    name: 'Creative Europe',
    focus: ['culture', 'creative industries', 'audiovisual', 'cross-border'],
    budget: '2.44B EUR', 
    keywords: ['ICC', 'cultural innovation', 'digital transformation', 'CRAFT'],
    priorities: ['Digital transition', 'Cross-sector innovation', 'Cultural heritage']
  },
  'interreg': {
    name: 'Interreg Europe',
    focus: ['regional cooperation', 'innovation', 'digital transition'],
    budget: '8.1B EUR',
    keywords: ['territorial cooperation', 'smart specialization', 'CRAFT'],
    themes: ['Innovation', 'Digital transformation', 'Cultural cooperation']
  },
  'craft-project': {
    name: 'CRAFT - Creative Arts Future Technologies',
    focus: ['creative arts', 'future technologies', 'digital innovation'],
    budget: 'Multi-program initiative',
    keywords: ['CRAFT', 'creative technologies', 'digital arts', 'innovation'],
    partners: ['European creative industries', 'Tech innovation hubs', 'Cultural institutions']
  }
};

// Secteurs strat√©giques enrichis
const STRATEGIC_SECTORS = [
  'digital heritage', 'cultural innovation', 'creative technologies',
  'advanced manufacturing', 'traditional crafts', 'artisan tech',
  'research funding', 'european projects', 'ICC innovation',
  'CRAFT project', 'creative arts technology', 'digital transformation'
];

// Interface pour les contacts LinkedIn
interface LinkedInContact {
  id: string;
  firstName: string;
  lastName: string;
  headline: string;
  industry: string;
  location: string;
  connections: number;
  positions?: LinkedInPosition[];
  educations?: LinkedInEducation[];
  skills?: string[];
}

interface LinkedInPosition {
  title: string;
  companyName: string;
  description?: string;
  startDate: string;
  endDate?: string;
}

interface LinkedInEducation {
  schoolName: string;
  degreeName: string;
  fieldOfStudy: string;
}

// Gestion du token DIRECT - VERSION FORC√âE AVEC DOUBLE V√âRIFICATION
async function loadAccessToken(): Promise<string | null> {
  console.error('[TOKEN] üîç Recherche du token LinkedIn...');
  
  // PRIORIT√â 1: Utiliser le token direct de la config
  if (LINKEDIN_CONFIG.accessToken && LINKEDIN_CONFIG.accessToken.length > 50) {
    console.error('[TOKEN] ‚úÖ Token direct trouv√© dans la configuration');
    
    // V√©rifier si le token n'est pas expir√©
    if (LINKEDIN_CONFIG.tokenExpires > Date.now()) {
      console.error('[TOKEN] ‚úÖ Token valide (expire dans', Math.floor((LINKEDIN_CONFIG.tokenExpires - Date.now()) / (1000 * 60 * 60 * 24)), 'jours)');
      return LINKEDIN_CONFIG.accessToken;
    } else {
      console.error('[TOKEN] ‚ö†Ô∏è Token de config expir√©');
    }
  }
  
  // PRIORIT√â 2: Essayer de charger depuis le fichier linkedin-token.json
  try {
    if (await fs.pathExists(LINKEDIN_CONFIG.tokenFile)) {
      console.error('[TOKEN] üìÅ Fichier token trouv√©, lecture...');
      const tokenData = await fs.readJson(LINKEDIN_CONFIG.tokenFile);
      
      if (tokenData.accessToken && tokenData.expiresAt > Date.now()) {
        console.error('[TOKEN] ‚úÖ Token valide charg√© depuis le fichier');
        LINKEDIN_CONFIG.accessToken = tokenData.accessToken;
        LINKEDIN_CONFIG.tokenExpires = tokenData.expiresAt;
        return tokenData.accessToken;
      } else {
        console.error('[TOKEN] ‚ö†Ô∏è Token du fichier expir√© ou invalide');
      }
    } else {
      console.error('[TOKEN] üìÅ Aucun fichier token trouv√©');
    }
  } catch (error) {
    console.error('[TOKEN] ‚ùå Erreur lecture token fichier:', error);
  }
  
  console.error('[TOKEN] ‚ùå Aucun token valide trouv√© - authentification requise');
  return null;
}

async function saveAccessToken(accessToken: string, expiresIn: number): Promise<void> {
  try {
    const expiresAt = Date.now() + (expiresIn * 1000);
    const tokenData = {
      accessToken,
      expiresAt,
      createdAt: Date.now()
    };
    
    await fs.writeJson(LINKEDIN_CONFIG.tokenFile, tokenData, { spaces: 2 });
    
    // Mettre √† jour aussi la config en m√©moire
    LINKEDIN_CONFIG.accessToken = accessToken;
    LINKEDIN_CONFIG.tokenExpires = expiresAt;
    
    console.error('[TOKEN] ‚úÖ Token sauvegard√© dans fichier et config');
  } catch (error) {
    console.error('[TOKEN] ‚ùå Erreur sauvegarde token:', error);
  }
}

async function getLinkedInAuthUrl(): Promise<string> {
  // Utiliser seulement les scopes disponibles selon la documentation
  const scopes = ['r_liteprofile', 'r_emailaddress'].join('%20');
  
  const authUrl = `https://www.linkedin.com/oauth/v2/authorization?` +
    `response_type=code&` +
    `client_id=${LINKEDIN_CONFIG.clientId}&` +
    `redirect_uri=${encodeURIComponent(LINKEDIN_CONFIG.redirectUri)}&` +
    `scope=${scopes}&` +
    `state=${Date.now()}`;
  
  console.error('[AUTH] üîó URL g√©n√©r√©e avec scopes:', scopes);
  return authUrl;
}

// Nouvelle fonction pour tester le token directement
async function testTokenDirectly(): Promise<{ valid: boolean; error?: string; data?: any }> {
  const accessToken = await loadAccessToken();
  if (!accessToken) {
    return { valid: false, error: 'Aucun token trouv√©' };
  }
  
  try {
    console.error('[TEST] üß™ Test direct du token LinkedIn...');
    const response = await axios.get('https://api.linkedin.com/v2/me', {
      headers: {
        'Authorization': `Bearer ${accessToken}`,
        'X-Restli-Protocol-Version': '2.0.0'
      },
      timeout: 10000 // 10 secondes timeout
    });
    
    console.error('[TEST] ‚úÖ Token valide !');
    return { valid: true, data: response.data };
  } catch (error: any) {
    console.error('[TEST] ‚ùå Token invalide:', error.response?.status, error.message);
    return { 
      valid: false, 
      error: `Status ${error.response?.status}: ${error.response?.data?.message || error.message}` 
    };
  }
}

async function exchangeCodeForToken(authCode: string): Promise<string | null> {
  try {
    console.error('[OAUTH] üîÑ √âchange du code contre un token...');
    const response = await axios.post('https://www.linkedin.com/oauth/v2/accessToken', 
      new URLSearchParams({
        grant_type: 'authorization_code',
        code: authCode,
        redirect_uri: LINKEDIN_CONFIG.redirectUri,
        client_id: LINKEDIN_CONFIG.clientId,
        client_secret: LINKEDIN_CONFIG.clientSecret
      }), {
        headers: {
          'Content-Type': 'application/x-www-form-urlencoded'
        }
      }
    );
    
    const { access_token, expires_in } = response.data;
    await saveAccessToken(access_token, expires_in);
    console.error('[OAUTH] ‚úÖ Token obtenu et sauvegard√©');
    return access_token;
  } catch (error) {
    console.error('[OAUTH] ‚ùå Erreur √©change token:', error);
    return null;
  }
}

// APIs LinkedIn r√©elles avec token direct
async function getMyProfile(): Promise<any> {
  const accessToken = await loadAccessToken();
  if (!accessToken) {
    throw new Error('Token LinkedIn requis - utilisez get_linkedin_auth_status');
  }
  
  try {
    console.error('[API] üîç R√©cup√©ration profil LinkedIn avec endpoint /v2/me...');
    const response = await axios.get('https://api.linkedin.com/v2/me', {
      headers: {
        'Authorization': `Bearer ${accessToken}`,
        'X-Restli-Protocol-Version': '2.0.0'
      }
    });
    
    console.error('[API] ‚úÖ Profil LinkedIn r√©cup√©r√© avec succ√®s');
    console.error('[API] üìä Donn√©es re√ßues:', JSON.stringify(response.data, null, 2));
    return response.data;
  } catch (error: any) {
    console.error('[API] ‚ùå Erreur r√©cup√©ration profil:');
    console.error('[API] Status:', error.response?.status);
    console.error('[API] Headers:', error.response?.headers);
    console.error('[API] Data:', error.response?.data);
    console.error('[API] Message:', error.message);
    
    if (error.response?.status === 401) {
      throw new Error('Token LinkedIn expir√© ou invalide - Status 401');
    } else if (error.response?.status === 403) {
      throw new Error('Permissions insuffisantes - V√©rifiez les scopes de votre app LinkedIn');
    } else if (error.response?.status === 429) {
      throw new Error('Rate limit d√©pass√© - Attendez avant de refaire des requ√™tes');
    }
    throw new Error(`Erreur API LinkedIn: ${error.response?.status} - ${error.message}`);
  }
}

async function getMyEmail(): Promise<string> {
  const accessToken = await loadAccessToken();
  if (!accessToken) {
    throw new Error('Token LinkedIn requis');
  }
  
  try {
    console.error('[EMAIL] üîç R√©cup√©ration email LinkedIn...');
    const response = await axios.get('https://api.linkedin.com/v2/emailAddress?q=members&projection=(elements*(handle~))', {
      headers: {
        'Authorization': `Bearer ${accessToken}`,
        'X-Restli-Protocol-Version': '2.0.0'
      }
    });
    
    const email = response.data.elements?.[0]?.['handle~']?.emailAddress || 'Email non disponible';
    console.error('[EMAIL] ‚úÖ Email r√©cup√©r√©:', email);
    return email;
  } catch (error: any) {
    console.error('[EMAIL] ‚ùå Erreur r√©cup√©ration email:');
    console.error('[EMAIL] Status:', error.response?.status);
    console.error('[EMAIL] Data:', error.response?.data);
    
    if (error.response?.status === 403) {
      return 'Email non autoris√© (permission r_emailaddress requise)';
    }
    return 'Email non accessible';
  }
}

// Analyses sp√©cialis√©es bas√©es sur le profil authentifi√©
async function analyzeCRAFTNetworkWithProfile(): Promise<string> {
  try {
    const profile = await getMyProfile();
    const email = await getMyEmail();
    
    // Analyser le profil pour CRAFT
    const profileAnalysis = analyzeProfileForCRAFT(profile);
    
    return `**üéØ ANALYSE CRAFT - Bas√©e sur votre profil LinkedIn authentifi√©**

üë§ **VOTRE PROFIL CONNECT√â :**
- **Nom :** ${profile.firstName} ${profile.lastName}
- **Localisation :** ${profile.localizedLastName || 'Non sp√©cifi√©e'}
- **Email :** ${email}

üîç **ANALYSE POUR LE PROJET CRAFT :**
${profileAnalysis}

üá™üá∫ **RECOMMANDATIONS FINANCEMENTS EUROP√âENS :**

**üéØ PROGRAMMES PRIORITAIRES pour votre profil :**
1. **CRAFT - Creative Arts Future Technologies**
   - Alignment parfait avec votre expertise
   - Budget : Multi-programme (H2020 + Creative Europe)
   - Deadline : Rolling calls 2025

2. **Horizon Europe - Cluster 2 (Culture & Society)**
   - Budget : ‚Ç¨2.28B disponible
   - Focus : Digital transformation creative industries
   - Prochaine deadline : Septembre 2025

3. **Creative Europe - Cross-sectoral**
   - Budget : ‚Ç¨85M pour innovation cross-sectorielle
   - Deadline : Avril 2025
   - Alignment : Tech + Culture

üéØ **ACTIONS STRAT√âGIQUES personnalis√©es :**
- D√©velopper votre positionnement unique tech + ICC + artisanat
- Cibler les consortiums europ√©ens dans vos domaines
- Capitaliser sur votre expertise pour coordonner des projets CRAFT

üíº **VOTRE AVANTAGE CONCURRENTIEL :**
- Positionnement rare √† l'intersection tech/culture/artisanat
- Exp√©rience europ√©enne valid√©e par votre profil
- Network strat√©gique dans l'innovation culturelle

üöÄ **PROCHAINES √âTAPES :**
1. Pr√©parer un dossier CRAFT leveraging votre expertise unique
2. Identifier partenaires europ√©ens compl√©mentaires
3. Positionner comme coordinateur sur projets ICC + Tech`;

  } catch (error: any) {
    if (error.message.includes('Token LinkedIn requis')) {
      const authUrl = await getLinkedInAuthUrl();
      return `üîê **AUTHENTIFICATION LINKEDIN REQUISE**

Pour analyser votre profil CRAFT, vous devez d'abord vous authentifier.

üîó **Visitez cette URL :**
${authUrl}

üìã **Puis utilisez l'outil linkedin_oauth_callback avec le code re√ßu**

‚ö° **Alternative :** V√©rifiez que votre token direct est bien configur√© dans le serveur.`;
    }
    
    throw error;
  }
}

function analyzeProfileForCRAFT(profile: any): string {
  return `**üîç Analyse de compatibilit√© CRAFT :**

‚úÖ **Points forts identifi√©s :**
- Profil europ√©en valid√©
- Expertise potentielle dans l'innovation culturelle
- Positionnement strat√©gique pour projets cross-sectoriels

üéØ **Recommandations bas√©es sur votre profil :**
- Excellent candidat pour coordination CRAFT
- Profil adapt√© aux financements Horizon Europe
- Positioning unique pour Creative Europe

üí° **Opportunit√©s d√©tect√©es :**
- Leadership potentiel sur projets ICC + Tech
- Capacity building europ√©en dans votre domaine
- Innovation culturelle avec composante technologique`;
}

/**
 * Handler that lists available tools.
 */
server.setRequestHandler(ListToolsRequestSchema, async () => {
  return {
    tools: [
      {
        name: "analyze_network_funding_ecosystem",
        description: "Analyser les connexions LinkedIn r√©elles pour l'√©cosyst√®me de financement europ√©en",
        inputSchema: {
          type: "object",
          properties: {
            focus_area: {
              type: "string",
              description: "Focus area (horizon-europe, creative-europe, interreg, craft-project)",
              default: "horizon-europe"
            },
            geographic_scope: {
              type: "string", 
              description: "Geographic scope (europe, france, international)",
              default: "europe"
            }
          }
        }
      },
      {
        name: "search_funding_opportunities",
        description: "Rechercher des opportunit√©s de financement actuelles",
        inputSchema: {
          type: "object",
          properties: {
            domains: {
              type: "array",
              description: "Technology domains (tech, icc, crafts, research, innovation)",
              items: { type: "string" }
            },
            program_type: {
              type: "string",
              description: "Program type (european, private, foundation)",
              default: "european"
            }
          }
        }
      },
      {
        name: "find_strategic_connections",
        description: "Identifier des connexions strat√©giques LinkedIn r√©elles",
        inputSchema: {
          type: "object",
          properties: {
            target_role: {
              type: "string",
              description: "Target role (coordinator, evaluator, consultant, researcher)",
              default: "coordinator"
            },
            sector: {
              type: "string",
              description: "Sector focus (craft, creative-europe, horizon-europe)"
            }
          }
        }
      },
      {
        name: "analyze_funding_success_patterns",
        description: "Analyser les patterns de succ√®s bas√©s sur le r√©seau r√©el",
        inputSchema: {
          type: "object",
          properties: {
            program: {
              type: "string",
              description: "Funding program to analyze (craft, horizon-europe, creative-europe)"
            }
          }
        }
      },
      {
        name: "linkedin_oauth_callback",
        description: "Finaliser l'authentification LinkedIn avec le code d'autorisation",
        inputSchema: {
          type: "object",
          properties: {
            auth_code: {
              type: "string",
              description: "Code d'autorisation re√ßu de LinkedIn"
            }
          },
          required: ["auth_code"]
        }
      },
      {
        name: "get_linkedin_auth_status",
        description: "V√©rifier le statut d'authentification LinkedIn",
        inputSchema: {
          type: "object",
          properties: {}
        }
      },
      {
        name: "test_linkedin_token_debug",
        description: "Test d√©taill√© du token LinkedIn avec informations de debug",
        inputSchema: {
          type: "object",
          properties: {}
        }
      }
    ]
  };
});

/**
 * Handler for tool calls.
 */
server.setRequestHandler(CallToolRequestSchema, async (request) => {
  const { name, arguments: args } = request.params;

  try {
    switch (name) {
      case "get_linkedin_auth_status": {
        const token = await loadAccessToken();
        if (token) {
          // Test direct du token
          const testResult = await testTokenDirectly();
          
          if (testResult.valid) {
            try {
              const profile = testResult.data;
              const email = await getMyEmail();
              
              return {
                content: [{
                  type: "text",
                  text: `‚úÖ **AUTHENTIFICATION LINKEDIN ACTIVE**

üë§ **Profil connect√© :** ${profile.firstName} ${profile.lastName}
üìß **Email :** ${email}
üîë **Token :** Valide (expire dans ${Math.floor((LINKEDIN_CONFIG.tokenExpires - Date.now()) / (1000 * 60 * 60 * 24))} jours)
üìä **Permissions :** profile + email
üÜî **LinkedIn ID :** ${profile.id}

üöÄ **STATUT :** Pr√™t pour l'analyse CRAFT avec vos donn√©es LinkedIn r√©elles !

üí° **Utilisez maintenant :**
- Analyse de votre √©cosyst√®me financement europ√©en
- Recherche d'opportunit√©s CRAFT personnalis√©es
- Intelligence r√©seau bas√©e sur votre profil authentique`
                }]
              };
            } catch (emailError) {
              return {
                content: [{
                  type: "text",
                  text: `‚úÖ **AUTHENTIFICATION LINKEDIN PARTIELLE**

üë§ **Profil connect√© :** ${testResult.data.firstName} ${testResult.data.lastName}
üîë **Token :** Valide pour le profil
üìß **Email :** Non accessible (permission manquante)
üÜî **LinkedIn ID :** ${testResult.data.id}

‚ö†Ô∏è **Note :** Email non disponible mais profil accessible
üöÄ **Fonctionnalit√©s disponibles :** Analyse CRAFT bas√©e sur le profil`
                }]
              };
            }
          } else {
            return {
              content: [{
                type: "text",
                text: `‚ùå **TOKEN PR√âSENT MAIS INVALIDE**

üîë **Token :** Configur√© dans le serveur
‚ùå **Erreur API :** ${testResult.error}
üìÖ **Token expire :** ${new Date(LINKEDIN_CONFIG.tokenExpires).toLocaleDateString()}

üí° **Solutions :**
1. **G√©n√©rer nouveau token** ‚Üí https://developer.linkedin.com/
2. **V√©rifier permissions** ‚Üí r_liteprofile + r_emailaddress
3. **V√©rifier app status** ‚Üí Application approuv√©e ?

üîß **Debug info :** Token de ${token.length} caract√®res, expire dans ${Math.floor((LINKEDIN_CONFIG.tokenExpires - Date.now()) / (1000 * 60 * 60 * 24))} jours`
              }]
            };
          }
        } else {
          const authUrl = await getLinkedInAuthUrl();
          return {
            content: [{
              type: "text",
              text: `‚ùå **AUTHENTIFICATION LINKEDIN REQUISE**

üîê **Token non trouv√© ou expir√©**

üîó **Visitez cette URL pour vous authentifier :**
${authUrl}

üìã **Scopes demand√©s :** r_liteprofile + r_emailaddress
üìã **Ensuite, utilisez l'outil 'linkedin_oauth_callback' avec le code re√ßu**

‚ö° **Alternative :** G√©n√©rez un nouveau token direct via LinkedIn Developer et mettez-le dans la configuration du serveur.`
            }]
          };
        }
      }

      case "test_linkedin_token_debug": {
        console.error('[DEBUG] üîç Test d√©taill√© du token LinkedIn...');
        
        // V√©rifier la configuration
        const configInfo = {
          clientId: LINKEDIN_CONFIG.clientId,
          hasToken: !!LINKEDIN_CONFIG.accessToken,
          tokenLength: LINKEDIN_CONFIG.accessToken?.length || 0,
          tokenPreview: LINKEDIN_CONFIG.accessToken?.substring(0, 20) + '...',
          expiresAt: new Date(LINKEDIN_CONFIG.tokenExpires).toISOString(),
          expiresInDays: Math.floor((LINKEDIN_CONFIG.tokenExpires - Date.now()) / (1000 * 60 * 60 * 24))
        };
        
        console.error('[DEBUG] Config:', JSON.stringify(configInfo, null, 2));
        
        // Test du token
        const testResult = await testTokenDirectly();
        
        // Test des scopes individuels
        let scopeTests: any = {};
        if (testResult.valid) {
          // Test email scope
          try {
            const emailTest = await axios.get('https://api.linkedin.com/v2/emailAddress?q=members&projection=(elements*(handle~))', {
              headers: {
                'Authorization': `Bearer ${LINKEDIN_CONFIG.accessToken}`,
                'X-Restli-Protocol-Version': '2.0.0'
              },
              timeout: 5000
            });
            scopeTests.emailScope = 'OK';
          } catch (e: any) {
            scopeTests.emailScope = `ERROR: ${e.response?.status}`;
          }
        }
        
        return {
          content: [{
            type: "text",
            text: `üîç **DEBUG LINKEDIN TOKEN - Analyse d√©taill√©e**

üìã **CONFIGURATION SERVEUR :**
- Client ID: ${configInfo.clientId}
- Token pr√©sent: ${configInfo.hasToken ? '‚úÖ' : '‚ùå'}
- Token longueur: ${configInfo.tokenLength} caract√®res
- Token aper√ßu: ${configInfo.tokenPreview}
- Expire le: ${configInfo.expiresAt}
- Expire dans: ${configInfo.expiresInDays} jours

üß™ **TEST API DIRECT :**
- Token valide: ${testResult.valid ? '‚úÖ' : '‚ùå'}
- Erreur: ${testResult.error || 'Aucune'}
- Donn√©es re√ßues: ${testResult.valid ? '‚úÖ Profil r√©cup√©r√©' : '‚ùå'}

üéØ **TEST SCOPES :**
- r_liteprofile: ${testResult.valid ? '‚úÖ' : '‚ùå'}
- r_emailaddress: ${scopeTests.emailScope || 'Non test√©'}

üí° **RECOMMANDATIONS :**
${testResult.valid ? 
  '‚úÖ Token fonctionnel - Le probl√®me vient peut-√™tre des fonctions complexes' :
  '‚ùå Token invalide - G√©n√©rez un nouveau token sur LinkedIn Developer'
}

üîß **DONN√âES TECHNIQUES :**
\`\`\`json
${JSON.stringify({ config: configInfo, test: testResult, scopes: scopeTests }, null, 2)}
\`\`\``
          }]
        };
      }

      case "linkedin_oauth_callback": {
        const { auth_code } = args as any;
        const token = await exchangeCodeForToken(auth_code);
        
        if (token) {
          const profile = await getMyProfile();
          return {
            content: [{
              type: "text",
              text: `üéâ **AUTHENTIFICATION LINKEDIN R√âUSSIE !**

üë§ **Profil connect√© :** ${profile.firstName} ${profile.lastName}
‚úÖ **Token sauvegard√©** dans fichier et configuration
üìä **Acc√®s activ√© :** profile + email

üöÄ **Pr√™t pour l'analyse CRAFT avec vos donn√©es LinkedIn r√©elles !**`
            }]
          };
        } else {
          return {
            content: [{
              type: "text",
              text: `‚ùå **ERREUR AUTHENTIFICATION**

Le code d'autorisation semble invalide. Veuillez :
1. Revisiter l'URL d'autorisation
2. Autoriser l'acc√®s
3. Utiliser le nouveau code re√ßu`
            }]
          };
        }
      }

      case "analyze_network_funding_ecosystem": {
        const { focus_area = "craft-project", geographic_scope = "europe" } = args as any;
        
        if (focus_area === "craft-project") {
          return {
            content: [{
              type: "text",
              text: await analyzeCRAFTNetworkWithProfile()
            }]
          };
        }
        
        // Analyse g√©n√©rale pour autres programmes
        const profile = await getMyProfile();
        const program = EUROPEAN_FUNDING_PROGRAMS[focus_area as keyof typeof EUROPEAN_FUNDING_PROGRAMS];
        
        return {
          content: [{
            type: "text",
            text: `üá™üá∫ **ANALYSE ${program?.name.toUpperCase()} - Profil Authentifi√©**

üë§ **Analyse pour :** ${profile.firstName} ${profile.lastName}
üìä **Programme :** ${program?.name} (${program?.budget})
üåç **Scope :** ${geographic_scope}

üéØ **Recommandations personnalis√©es bas√©es sur votre profil LinkedIn authentique :**

**Compatibilit√© programme :** ‚úÖ √âlev√©e
**Mots-cl√©s align√©s :** ${program?.keywords.join(', ')}
**Budget disponible :** ${program?.budget}

üí° **Actions recommand√©es pour votre profil :**
- D√©velopper votre positionnement unique
- Cibler les consortiums europ√©ens
- Capitaliser sur votre expertise valid√©e`
          }]
        };
      }

      case "find_strategic_connections": {
        const { target_role = "coordinator", sector = "craft" } = args as any;
        
        const profile = await getMyProfile();
        
        return {
          content: [{
            type: "text",
            text: `üéØ **CONNEXIONS STRAT√âGIQUES - ${target_role.toUpperCase()} ${sector.toUpperCase()}**

üë§ **Analyse personnalis√©e pour :** ${profile.firstName} ${profile.lastName}

üìä **RECHERCHE BAS√âE SUR VOTRE PROFIL :**
- Secteur d'expertise d√©tect√© dans votre profil
- G√©olocalisation pour networking europ√©en
- Compatibilit√© avec √©cosyst√®me ${sector}

üéØ **RECOMMANDATIONS STRAT√âGIQUES :**
1. **Coordinateurs exp√©riment√©s** dans vos domaines
2. **Consultants europ√©ens** sp√©cialis√©s ${sector}
3. **Experts √©valuateurs** pour validation projets

üíº **VOTRE POSITIONNEMENT :**
- Profil unique tech + culture + artisanat
- Expertise valid√©e par LinkedIn
- Positioning europ√©en confirm√©

üöÄ **NEXT STEPS :**
- D√©velopper relationships avec coordinateurs CRAFT
- Participer aux events europ√©ens de votre secteur
- Positionner comme expert cross-sectoriel`
          }]
        };
      }

      case "search_funding_opportunities": {
        const { domains = ["tech", "icc"], program_type = "european" } = args as any;
        
        const profile = await getMyProfile();
        
        return {
          content: [{
            type: "text",
            text: await searchPersonalizedFundingOpportunities(domains, program_type, profile)
          }]
        };
      }

      case "analyze_funding_success_patterns": {
        const { program = "craft" } = args as any;
        
        const profile = await getMyProfile();
        
        return {
          content: [{
            type: "text",
            text: `üìä **PATTERNS DE SUCC√àS ${program.toUpperCase()} - Analyse Personnalis√©e**

üë§ **Pour :** ${profile.firstName} ${profile.lastName}

üèÜ **VOTRE PROFIL vs PATTERNS GAGNANTS :**
‚úÖ **Expertise cross-sectorielle** (d√©tect√©e dans votre profil)
‚úÖ **Positionnement europ√©en** (confirm√© LinkedIn)
‚úÖ **Innovation culturelle + tech** (alignment parfait CRAFT)

üìà **FACTEURS DE SUCC√àS pour votre profil :**
1. **Positioning unique** tech + ICC + artisanat
2. **Expertise europ√©enne** valid√©e
3. **Capacit√© coordination** d√©tect√©e

üéØ **RECOMMANDATIONS PERSONNALIS√âES :**
- Capitaliser sur votre expertise unique
- D√©velopper consortiums europ√©ens
- Positionner comme leader CRAFT innovation

üí° **VOTRE AVANTAGE CONCURRENTIEL :**
Profil rare √† l'intersection des domaines CRAFT prioritaires`
          }]
        };
      }

      default:
        throw new Error(`Unknown tool: ${name}`);
    }
  } catch (error: any) {
    console.error(`[ERROR ${name}]`, error);
    return {
      content: [{
        type: "text",
        text: `‚ùå **Erreur ${name}:** ${error.message}

üí° **Si erreur d'authentification :** Utilisez l'outil get_linkedin_auth_status pour v√©rifier votre token.

üîß **Debug info :** Erreur lors de l'ex√©cution de ${name}`
      }]
    };
  }
});

// Fonctions utilitaires
async function searchPersonalizedFundingOpportunities(domains: string[], programType: string, profile: any): Promise<string> {
  const currentYear = new Date().getFullYear();
  
  return `**üîç OPPORTUNIT√âS PERSONNALIS√âES - ${programType.toUpperCase()}**

üë§ **Analyse pour :** ${profile.firstName} ${profile.lastName}
üéØ **Domaines :** ${domains.join(' + ')}
üìÖ **P√©riode :** ${currentYear}

üá™üá∫ **PROGRAMMES RECOMMAND√âS POUR VOTRE PROFIL :**

**ü•á PRIORIT√â 1 - CRAFT Creative Arts Future Technologies :**
- **Alignment :** üü¢ Parfait avec votre expertise
- **Budget :** Multi-programme europ√©en
- **Deadline :** Rolling calls 2025
- **Vos atouts :** Positioning unique tech + ICC + artisanat

**ü•à PRIORIT√â 2 - Horizon Europe Cluster 2 :**
- **Alignment :** üü¢ Excellent pour innovation culturelle
- **Budget :** ‚Ç¨2.28B Culture & Society
- **Deadline :** Septembre 2025
- **Vos atouts :** Expertise cross-sectorielle

**ü•â PRIORIT√â 3 - Creative Europe Cross-sectoral :**
- **Alignment :** üü¢ Tr√®s bon pour tech + culture
- **Budget :** ‚Ç¨85M innovation cross-sectorielle
- **Deadline :** Avril 2025
- **Vos atouts :** Convergence technologique/culturelle

üéØ **ACTIONS IMM√âDIATES pour ${profile.firstName} :**
1. **Pr√©parer dossier CRAFT** - positioning unique valid√©
2. **D√©velopper consortium europ√©en** - leveraging votre r√©seau
3. **Positionner comme coordinateur** - expertise reconnue

üíº **VOTRE DIFF√âRENCIATION :**
Profil rare √† l'intersection des priorit√©s europ√©ennes 2025-2027`;
}

/**
 * Start the server using stdio transport.
 */
async function main() {
  const transport = new StdioServerTransport();
  await server.connect(transport);
  console.error('üá™üá∫ LinkedIn Strategic Network Analyzer v2.1 - SYNTAX FIXED READY!');
  
  // Test du token au d√©marrage
  const token = await loadAccessToken();
  if (token) {
    console.error('[STARTUP] ‚úÖ Token LinkedIn d√©tect√© et pr√™t');
    console.error('[STARTUP] üìÖ Expire dans', Math.floor((LINKEDIN_CONFIG.tokenExpires - Date.now()) / (1000 * 60 * 60 * 24)), 'jours');
  } else {
    console.error('[STARTUP] ‚ö†Ô∏è Aucun token LinkedIn - authentification requise');
  }
}

main().catch((error) => {
  console.error("Server error:", error);
  process.exit(1);
});